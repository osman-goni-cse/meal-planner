<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.springframework.org/security/tags">
<head th:replace="fragments/layout :: head"></head>
<body class="bg-gray-50 font-sans">
    <div class="flex min-h-screen">
        <aside th:replace="fragments/layout :: sidebar" class="hidden md:flex"></aside>
        <div class="flex flex-col flex-1 ml-0 md:ml-64">
            <header th:replace="fragments/layout :: topnav" class="hidden md:block"></header>
            <div th:replace="fragments/layout :: mobile-navbar" class="md:hidden"></div>
            <main class="flex-1 px-2 md:px-6 md:py-6">
                <!-- Responsive Filters/Search -->
                <section id="dish-filters-section" class="bg-white rounded-lg shadow-sm p-4 md:p-6 mb-4 md:mb-8">
                    <form id="dish-filters-form" method="get" action="/dishes" class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 md:gap-4">
                        <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 flex-1">
                            <div class="relative flex-1 max-w-md mb-2 md:mb-0">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="search-input" name="search" placeholder="Search dishes by name..." th:value="${search}" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div class="flex flex-row gap-2 w-full md:w-auto mb-2 md:mb-0 md:flex-nowrap flex-wrap">
                                <select id="meal-period-filter" name="mealPeriod" class="flex-1 min-w-0 h-10 text-xs px-2 py-0 md:h-auto md:text-sm md:px-4 md:py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">All Meal Periods</option>
                                    <option value="LUNCH" th:selected="${mealPeriod == 'LUNCH'}">Lunch</option>
                                    <option value="SNACKS" th:selected="${mealPeriod == 'SNACKS'}">Snacks</option>
                                </select>
                                <select id="category-filter" name="category" class="flex-1 min-w-0 h-10 text-xs px-2 py-0 md:h-auto md:text-sm md:px-4 md:py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">All Categories</option>
                                    <option value="Main Course" th:selected="${category == 'Main Course'}">Main Course</option>
                                    <option value="Side Dish" th:selected="${category == 'Side Dish'}">Side Dish</option>
                                    <option value="Beverage" th:selected="${category == 'Beverage'}">Beverage</option>
                                    <option value="Dessert" th:selected="${category == 'Dessert'}">Dessert</option>
                                </select>
                                <a href="/dishes" class="flex-1 min-w-0 h-10 text-xs px-2 py-0 md:h-auto md:text-sm md:px-4 md:py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition flex items-center justify-center md:w-auto md:flex-none whitespace-nowrap">
                                    <i class="fa-solid fa-filter mr-2"></i>
                                    <span class="whitespace-nowrap">Clear Filters</span>
                                </a>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 w-full md:w-auto">
                            <div class="w-full md:w-auto" sec:authorize="hasAuthority('ROLE_ADMIN')">
                                <button class="w-full md:w-auto bg-white text-primary px-6 py-2 rounded-full shadow-md hover:bg-gray-100 transition flex items-center justify-center font-medium"
                                        type="button" onclick="openAddDishModal()">
                                    <i class="fa-solid fa-plus mr-2"></i>
                                    <span>Add New Dish</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </section>
                
                <section id="dishes-grid-section" class="mb-8">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800 hidden md:block">All Dishes</h3>
                                <div class="flex items-center text-sm text-gray-600 w-full md:w-auto justify-end">
                                    <span id="dish-count-display" class="hidden md:inline" th:text="'Showing ' + (${currentPage * pageSize + 1}) + '-' + (${currentPage * pageSize + dishes.size()}) + ' of ' + ${dishCount} + ' dishes'"></span>
                                    <!-- Pagination Controls (Top Right) -->
                                    <nav class="flex items-center gap-1 ml-0 md:ml-6 overflow-x-auto" aria-label="Pagination" th:if="${dishesPage.totalPages > 1}">
                                        <a th:href="@{/dishes(page=${currentPage-1},size=${pageSize},search=${search},mealPeriod=${mealPeriod},category=${category})}"
                                           class="px-2 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-100 rounded-l-md"
                                           th:classappend="${dishesPage.first} ? 'pointer-events-none opacity-50' : ''"
                                           th:if="${!dishesPage.first}">
                                            <i class="fa-solid fa-chevron-left"></i>
                                        </a>
                                        <span th:if="${dishesPage.first}" class="px-2 py-1 border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 rounded-l-md"><i class="fa-solid fa-chevron-left"></i></span>
                                        <span th:each="i : ${#numbers.sequence(0, dishesPage.totalPages-1)}">
                                            <a th:href="@{/dishes(page=${i},size=${pageSize},search=${search},mealPeriod=${mealPeriod},category=${category})}"
                                               th:text="${i+1}"
                                               class="px-2 py-1 border border-gray-300 text-sm font-medium hover:bg-primary hover:text-white"
                                               th:classappend="${i} == ${currentPage} ? 'bg-primary text-white' : 'bg-white text-gray-700'">
                                            </a>
                                        </span>
                                        <a th:href="@{/dishes(page=${currentPage+1},size=${pageSize},search=${search},mealPeriod=${mealPeriod},category=${category})}"
                                           class="px-2 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-100 rounded-r-md"
                                           th:classappend="${dishesPage.last} ? 'pointer-events-none opacity-50' : ''"
                                           th:if="${!dishesPage.last}">
                                            <i class="fa-solid fa-chevron-right"></i>
                                        </a>
                                        <span th:if="${dishesPage.last}" class="px-2 py-1 border border-gray-300 bg-gray-100 text-sm font-medium text-gray-400 rounded-r-md"><i class="fa-solid fa-chevron-right"></i></span>
                                    </nav>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                <div th:each="dish : ${dishes}" class="relative rounded-xl overflow-hidden group shadow-lg hover:shadow-2xl transition-all duration-300 ease-in-out transform hover:-translate-y-1 dish-card" 
                                     th:attr="data-dish-id=${dish.id},data-dish-name=${dish.name},data-meal-period=${dish.mealPeriod},data-category=${dish.category}">
                                    <img class="w-full h-80 object-cover" th:src="${dish.imageUrl}" th:alt="${dish.name}">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                                    
                                    <!-- Three-dot menu -->
                                    <div class="absolute top-4 right-4">
                                        <div class="relative">
                                            <button class="bg-white bg-opacity-90 hover:bg-opacity-100 p-2 rounded-full shadow-lg transition-all duration-200 group/menu" onclick="toggleDishMenu(this)">
                                                <i class="fa-solid fa-ellipsis-vertical text-gray-600"></i>
                                            </button>
                                            <!-- Dropdown menu -->
                                            <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 opacity-0 invisible group-hover/menu:opacity-100 group-hover/menu:visible transition-all duration-200 z-10 dish-menu">
                                                <div class="py-1">
                                                    <a href="#" th:onclick="'openViewDishModal(' + ${dish.id} + '); return false;'" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition">
                                                        <i class="fa-solid fa-eye mr-3 text-gray-500"></i>
                                                        View Details
                                                    </a>
                                                    <a href="#" th:onclick="'openEditDishModal(' + ${dish.id} + '); return false;'" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition" sec:authorize="hasAuthority('ROLE_ADMIN')">
                                                        <i class="fa-solid fa-edit mr-3 text-gray-500"></i>
                                                        Edit Dish
                                                    </a>
                                                    <hr class="my-1" sec:authorize="hasAuthority('ROLE_ADMIN')">
                                                    <button type="button"
                                                            th:attr="data-dish-id=${dish.id},data-dish-name=${dish.name}"
                                                            class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition"
                                                            sec:authorize="hasAuthority('ROLE_ADMIN')"
                                                            onclick="handleDeleteButtonClick(this)">
                                                        <i class="fa-solid fa-trash mr-3 text-red-500"></i>
                                                        Delete Dish
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="absolute bottom-0 left-0 p-4 w-full text-white">
                                        <h4 class="font-bold text-lg truncate mb-2" th:text="${dish.name}">Dish Name</h4>
                                        <div class="flex items-center justify-between text-sm">
                                            <div class="flex items-center space-x-2">
                                                <span class="bg-white bg-opacity-20 rounded px-2 py-1 text-xs font-medium" th:text="${dish.mealPeriod}">Meal Period</span>
                                                <span class="bg-white bg-opacity-20 rounded px-2 py-1 text-xs font-medium" th:text="${dish.category}">Category</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                                </div>
                                <!-- Optionally, add a placeholder card for empty slots -->
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            <div th:replace="fragments/layout :: footer"></div>
        </div>
    </div>
    <!-- Add Dish Modal Fragment -->
    <div th:replace="fragments/add-dish-modal :: add-dish-modal"></div>
    <!-- Edit Dish Modal Fragment -->
    <div th:replace="fragments/edit-dish-modal :: edit-dish-modal"></div>
    <!-- View Dish Modal Fragment -->
    <div th:replace="fragments/view-dish-modal :: view-dish-modal"></div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-light">
                <div class="flex items-center">
                    <i class="fa-solid fa-exclamation-triangle text-red-500 mr-3 text-xl"></i>
                    <h2 class="text-xl font-semibold text-gray-800">Confirm Delete</h2>
                </div>
                <button class="text-gray-400 hover:text-gray-600 text-xl" onclick="closeDeleteModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <!-- Modal Content -->
            <div class="p-6">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <i class="fa-solid fa-trash text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Delete Dish</h3>
                    <p class="text-sm text-gray-500 mb-6">
                        Are you sure you want to delete "<span id="delete-dish-name" class="font-semibold text-gray-700"></span>"? 
                        This action cannot be undone.
                    </p>
                </div>
            </div>
            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-light bg-gray-50">
                <button type="button" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium" onclick="closeDeleteModal()">
                    Cancel
                </button>
                <form id="delete-dish-form" method="post" style="display:inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition font-medium">
                        <i class="fa-solid fa-trash mr-2"></i>
                        Delete Dish
                    </button>
                </form>
            </div>
        </div>
    </div>
    <script>
    function setupAddDishValidation() {
        const form = document.getElementById('add-dish-form');
        if (!form) return;
        const nameInput = form.querySelector('[name="name"]');
        const mealPeriodInput = form.querySelector('[name="mealPeriod"]');
        const categoryInput = form.querySelector('[name="category"]');
        const descriptionInput = form.querySelector('[name="description"]');
        const submitBtn = document.getElementById('add-dish-submit');
        if (!nameInput || !mealPeriodInput || !categoryInput || !descriptionInput || !submitBtn) return;

        // Remove previous listeners to avoid duplicates
        nameInput.oninput = null; nameInput.onblur = null;
        mealPeriodInput.onchange = null; mealPeriodInput.onblur = null;
        categoryInput.onchange = null; categoryInput.onblur = null;
        descriptionInput.oninput = null; descriptionInput.onblur = null;

        // Error containers
        const nameError = nameInput.parentElement.querySelector('.client-error') || createErrorDiv(nameInput);
        const mealPeriodError = mealPeriodInput.parentElement.querySelector('.client-error') || createErrorDiv(mealPeriodInput);
        const categoryError = categoryInput.parentElement.querySelector('.client-error') || createErrorDiv(categoryInput);
        const descriptionError = descriptionInput.parentElement.querySelector('.client-error') || createErrorDiv(descriptionInput);

        // Track touched state
        let touched = { name: false, mealPeriod: false, category: false, description: false };

        function createErrorDiv(input) {
            const div = document.createElement('div');
            div.className = 'client-error text-red-600 text-xs mt-1';
            input.parentElement.appendChild(div);
            return div;
        }

        function validate(showAll = false) {
            let valid = true;
            // Name
            if ((!nameInput.value || nameInput.value.trim().length < 5)) {
                if (touched.name || showAll) nameError.textContent = 'Dish name must be at least 5 characters.';
                else nameError.textContent = '';
                valid = false;
            } else {
                nameError.textContent = '';
            }
            // Meal Period
            if (!mealPeriodInput.value) {
                if (touched.mealPeriod || showAll) mealPeriodError.textContent = 'Meal period is required.';
                else mealPeriodError.textContent = '';
                valid = false;
            } else {
                mealPeriodError.textContent = '';
            }
            // Category
            if (!categoryInput.value) {
                if (touched.category || showAll) categoryError.textContent = 'Category is required.';
                else categoryError.textContent = '';
                valid = false;
            } else {
                categoryError.textContent = '';
            }
            // Description
            if (!descriptionInput.value || descriptionInput.value.trim().length < 30) {
                if (touched.description || showAll) descriptionError.textContent = 'Description must be at least 30 characters.';
                else descriptionError.textContent = '';
                valid = false;
            } else {
                descriptionError.textContent = '';
            }
            submitBtn.disabled = !valid;
            return valid;
        }

        // Attach events
        nameInput.addEventListener('input', function() { touched.name = true; validate(); });
        nameInput.addEventListener('blur', function() { touched.name = true; validate(); });
        mealPeriodInput.addEventListener('change', function() { touched.mealPeriod = true; validate(); });
        mealPeriodInput.addEventListener('blur', function() { touched.mealPeriod = true; validate(); });
        categoryInput.addEventListener('change', function() { touched.category = true; validate(); });
        categoryInput.addEventListener('blur', function() { touched.category = true; validate(); });
        descriptionInput.addEventListener('input', function() { touched.description = true; validate(); });
        descriptionInput.addEventListener('blur', function() { touched.description = true; validate(); });

        // Initial validation (do not show errors)
        validate(false);

        // Prevent submit if invalid
        form.addEventListener('submit', function(e) {
            if (!validate(true)) {
                e.preventDefault();
            }
        });
    }

    function openAddDishModal() {
        document.getElementById('add-dish-modal').classList.remove('hidden');
        setupAddDishValidation();
    }
    function closeAddDishModal() {
        document.getElementById('add-dish-modal').classList.add('hidden');
    }

    async function openEditDishModal(dishId) {
        try {
            // Fetch dish data from REST endpoint
            const response = await fetch(`/dishes/json/${dishId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch dish data');
            }
            
            const dishData = await response.json();
            
            // Populate the edit form
            populateEditForm(dishData);
            
            // Show the modal
            document.getElementById('edit-dish-modal').classList.remove('hidden');
            setupEditDishValidation();
            
        } catch (error) {
            console.error('Error opening edit modal:', error);
            alert('Error loading dish data. Please try again.');
        }
    }

    function populateEditForm(dishData) {
        // Set form action
        const form = document.getElementById('edit-dish-form');
        form.action = `/dishes/edit/${dishData.id}`;
        
        // Populate form fields
        document.getElementById('edit-dish-name').value = dishData.name || '';
        document.getElementById('edit-dish-meal-period').value = dishData.mealPeriod || '';
        document.getElementById('edit-dish-category').value = dishData.category || '';
        document.getElementById('edit-dish-description').value = dishData.description || '';
        
        // Show current image in preview
        const preview = document.getElementById('edit-image-preview');
        if (dishData.imageUrl) {
            preview.innerHTML = `<img src="${dishData.imageUrl}" alt="Current dish image" class="w-full h-full object-cover rounded">`;
        } else {
            preview.innerHTML = `
                <div class="text-center text-gray-400">
                    <i class="fa-solid fa-image text-3xl mb-2"></i>
                    <p class="text-sm">No image available</p>
                </div>
            `;
        }
        
        // Set dietary info checkboxes
        const dietaryCheckboxes = document.querySelectorAll('#edit-dietary-tags input[type="checkbox"]');
        dietaryCheckboxes.forEach(checkbox => {
            checkbox.checked = dishData.dietaryInfo && dishData.dietaryInfo.includes(checkbox.value);
        });
    }

    function closeEditDishModal() {
        document.getElementById('edit-dish-modal').classList.add('hidden');
        // Reset form
        document.getElementById('edit-dish-form').reset();
        document.getElementById('edit-image-preview').innerHTML = `
            <div class="text-center text-gray-400">
                <i class="fa-solid fa-image text-3xl mb-2"></i>
                <p class="text-sm">Image preview will appear here</p>
            </div>
        `;
    }

    function setupEditDishValidation() {
        const form = document.getElementById('edit-dish-form');
        if (!form) return;
        const nameInput = form.querySelector('[name="name"]');
        const mealPeriodInput = form.querySelector('[name="mealPeriod"]');
        const categoryInput = form.querySelector('[name="category"]');
        const descriptionInput = form.querySelector('[name="description"]');
        const submitBtn = document.getElementById('edit-dish-submit');
        if (!nameInput || !mealPeriodInput || !categoryInput || !descriptionInput || !submitBtn) return;

        // Remove previous listeners to avoid duplicates
        nameInput.oninput = null; nameInput.onblur = null;
        mealPeriodInput.onchange = null; mealPeriodInput.onblur = null;
        categoryInput.onchange = null; categoryInput.onblur = null;
        descriptionInput.oninput = null; descriptionInput.onblur = null;

        // Error containers
        const nameError = nameInput.parentElement.querySelector('.client-error') || createErrorDiv(nameInput);
        const mealPeriodError = mealPeriodInput.parentElement.querySelector('.client-error') || createErrorDiv(mealPeriodInput);
        const categoryError = categoryInput.parentElement.querySelector('.client-error') || createErrorDiv(categoryInput);
        const descriptionError = descriptionInput.parentElement.querySelector('.client-error') || createErrorDiv(descriptionInput);

        // Track touched state
        let touched = { name: false, mealPeriod: false, category: false, description: false };

        function createErrorDiv(input) {
            const div = document.createElement('div');
            div.className = 'client-error text-red-600 text-xs mt-1';
            input.parentElement.appendChild(div);
            return div;
        }

        function validate(showAll = false) {
            let valid = true;
            // Name
            if ((!nameInput.value || nameInput.value.trim().length < 5)) {
                if (touched.name || showAll) nameError.textContent = 'Dish name must be at least 5 characters.';
                else nameError.textContent = '';
                valid = false;
            } else {
                nameError.textContent = '';
            }
            // Meal Period
            if (!mealPeriodInput.value) {
                if (touched.mealPeriod || showAll) mealPeriodError.textContent = 'Meal period is required.';
                else mealPeriodError.textContent = '';
                valid = false;
            } else {
                mealPeriodError.textContent = '';
            }
            // Category
            if (!categoryInput.value) {
                if (touched.category || showAll) categoryError.textContent = 'Category is required.';
                else categoryError.textContent = '';
                valid = false;
            } else {
                categoryError.textContent = '';
            }
            // Description
            if (!descriptionInput.value || descriptionInput.value.trim().length < 30) {
                if (touched.description || showAll) descriptionError.textContent = 'Description must be at least 30 characters.';
                else descriptionError.textContent = '';
                valid = false;
            } else {
                descriptionError.textContent = '';
            }
            submitBtn.disabled = !valid;
            return valid;
        }

        // Attach events
        nameInput.addEventListener('input', function() { touched.name = true; validate(); });
        nameInput.addEventListener('blur', function() { touched.name = true; validate(); });
        mealPeriodInput.addEventListener('change', function() { touched.mealPeriod = true; validate(); });
        mealPeriodInput.addEventListener('blur', function() { touched.mealPeriod = true; validate(); });
        categoryInput.addEventListener('change', function() { touched.category = true; validate(); });
        categoryInput.addEventListener('blur', function() { touched.category = true; validate(); });
        descriptionInput.addEventListener('input', function() { touched.description = true; validate(); });
        descriptionInput.addEventListener('blur', function() { touched.description = true; validate(); });

        // Initial validation (do not show errors)
        validate(false);

        // Prevent submit if invalid
        form.addEventListener('submit', function(e) {
            if (!validate(true)) {
                e.preventDefault();
            }
        });
    }

    function previewEditImage(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('edit-image-preview');
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Dish preview" class="w-full h-full object-cover rounded">`;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = `
                <div class="text-center text-gray-400">
                    <i class="fa-solid fa-image text-3xl mb-2"></i>
                    <p class="text-sm">Image preview will appear here</p>
                </div>
            `;
        }
    }

    // Image preview functionality
    function previewImage(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('image-preview');
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Dish preview" class="w-full h-full object-cover rounded">`;
            };
            reader.readAsDataURL(file);
        } else {
            preview.innerHTML = `
                <div class="text-center text-gray-400">
                    <i class="fa-solid fa-image text-3xl mb-2"></i>
                    <p class="text-sm">Image preview will appear here</p>
                </div>
            `;
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.querySelector('#add-dish-modal .border-dashed');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-primary', 'bg-blue-50');
            });
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('border-primary', 'bg-blue-50');
            });
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-primary', 'bg-blue-50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('dish-image').files = files;
                    document.getElementById('dish-image').dispatchEvent(new Event('change'));
                }
            });
        }
    });

    // Three-dot menu functionality
    function toggleDishMenu(button) {
        // Close all other menus first
        document.querySelectorAll('.dish-menu').forEach(menu => {
            if (menu !== button.nextElementSibling) {
                menu.classList.remove('opacity-100', 'visible');
                menu.classList.add('opacity-0', 'invisible');
            }
        });
        
        const menu = button.nextElementSibling;
        if (menu) {
            menu.classList.toggle('opacity-100');
            menu.classList.toggle('visible');
            menu.classList.toggle('opacity-0');
            menu.classList.toggle('invisible');
        }
    }

    // Close menus when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.group\\/menu')) {
            document.querySelectorAll('.dish-menu').forEach(menu => {
                menu.classList.remove('opacity-100', 'visible');
                menu.classList.add('opacity-0', 'invisible');
            });
        }
    });

    function closeDeleteModal() {
        document.getElementById('delete-confirmation-modal').classList.add('hidden');
    }

    function openDeleteModal(dishId, dishName) {
        // Set the dish name in the modal
        document.getElementById('delete-dish-name').textContent = dishName;
        
        // Set the form action
        const deleteForm = document.getElementById('delete-dish-form');
        deleteForm.action = `/dishes/delete/${dishId}`;
        
        // Show the modal
        document.getElementById('delete-confirmation-modal').classList.remove('hidden');
    }

    function handleDeleteButtonClick(button) {
        const dishId = button.getAttribute('data-dish-id');
        const dishName = button.getAttribute('data-dish-name');
        openDeleteModal(dishId, dishName);
    }

    // View Dish Modal Functions
    function openViewDishModal(dishId) {
        fetch(`/dishes/json/${dishId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch dish data');
                }
                return response.json();
            })
            .then(dishData => {
                // Populate modal with dish data
                document.getElementById('view-dish-name').textContent = dishData.name;
                document.getElementById('view-dish-description').textContent = dishData.description;
                
                // Handle image display
                const imageElement = document.getElementById('view-dish-image');
                if (dishData.imageUrl && dishData.imageUrl.trim() !== '') {
                    imageElement.src = dishData.imageUrl;
                    imageElement.alt = dishData.name;
                } else {
                    // Show a placeholder for missing images
                    imageElement.src = '/images/default-dish.svg';
                    imageElement.alt = 'No image available';
                    imageElement.onerror = function() {
                        // If default image also fails, show a text placeholder
                        this.style.display = 'none';
                        this.parentElement.innerHTML = `
                            <div class="w-full h-full flex items-center justify-center bg-gray-200">
                                <div class="text-center text-gray-500">
                                    <i class="fa-solid fa-utensils text-4xl mb-2"></i>
                                    <p class="text-sm">No image available</p>
                                </div>
                            </div>
                        `;
                    };
                }
                
                // Set category and meal period
                const categorySpan = document.getElementById('view-dish-category');
                categorySpan.innerHTML = `<i class="fa-solid fa-utensils mr-2"></i>${dishData.category}`;
                
                const mealPeriodSpan = document.getElementById('view-dish-meal-period');
                mealPeriodSpan.innerHTML = `<i class="fa-solid fa-sun mr-2"></i>${dishData.mealPeriod}`;
                
                // Set date
                const dateSpan = document.getElementById('view-dish-date');
                if (dishData.createdDate) {
                    const createdDate = new Date(dishData.createdDate);
                    dateSpan.textContent = createdDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } else {
                    dateSpan.textContent = 'Date not available';
                }
                
                // Populate dietary tags
                populateDietaryTags(dishData.dietaryInfo || []);
                
                // Store current dish ID for edit functionality
                document.getElementById('view-dish-modal').setAttribute('data-current-dish-id', dishId);
                
                // Show the modal
                document.getElementById('view-dish-modal').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error loading dish data:', error);
                alert('Error loading dish data. Please try again.');
            });
    }

    function populateDietaryTags(dietaryInfo) {
        const container = document.getElementById('view-dietary-tags');
        const allTags = ['Vegetarian', 'Vegan', 'Gluten-Free', 'Dairy-Free', 'Nut-Free', 'Low-Carb', 'High-Protein', 'Spicy'];
        
        container.innerHTML = '';
        
        allTags.forEach(tag => {
            const isIncluded = dietaryInfo.includes(tag);
            const div = document.createElement('div');
            div.className = `flex items-center px-4 py-3 rounded-lg border transition-all duration-200 ${
                isIncluded 
                    ? 'bg-success bg-opacity-10 border-success border-opacity-20 shadow-sm' 
                    : 'bg-gray-100 border-gray-light opacity-60'
            }`;
            
            div.innerHTML = `
                <i class="fa-solid ${isIncluded ? 'fa-check-circle text-success' : 'fa-times-circle text-gray-400'} mr-3 text-lg"></i>
                <span class="font-medium text-sm ${isIncluded ? 'text-success' : 'text-gray-500'}">${tag}</span>
            `;
            
            container.appendChild(div);
        });
    }

    function closeViewDishModal() {
        document.getElementById('view-dish-modal').classList.add('hidden');
    }

    function openEditFromView() {
        const dishId = document.getElementById('view-dish-modal').getAttribute('data-current-dish-id');
        closeViewDishModal();
        openEditDishModal(dishId);
    }

    // Close view modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('view-dish-modal');
        if (e.target === modal) {
            closeViewDishModal();
        }
    });

    // Search and Filter Functionality
    document.addEventListener('DOMContentLoaded', function() {
        // The client-side filtering logic is now handled by the server-side Thymeleaf template
        // and the form submission.
        // --- Auto-submit for filters ---
        const form = document.getElementById('dish-filters-form');
        const mealPeriod = document.getElementById('meal-period-filter');
        const category = document.getElementById('category-filter');
        const searchInput = document.getElementById('search-input');
        if (form && mealPeriod && category && searchInput) {
            mealPeriod.addEventListener('change', () => form.submit());
            category.addEventListener('change', () => form.submit());
            let debounceTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    form.submit();
                }, 2000);
            });
        }
    });
    // Hamburger menu logic for mobile
    document.addEventListener('DOMContentLoaded', function() {
        var menuBtn = document.getElementById('mobile-menu-button');
        var menu = document.getElementById('mobile-menu');
        var closeBtn = document.getElementById('close-mobile-menu');
        if (menuBtn && menu) {
            menuBtn.onclick = function() { menu.classList.remove('hidden'); };
        }
        if (closeBtn && menu) {
            closeBtn.onclick = function() { menu.classList.add('hidden'); };
        }
        if (menu) {
            menu.addEventListener('click', function(e) {
                if (e.target === menu) menu.classList.add('hidden');
            });
        }
    });
    </script>
</body>
</html> 